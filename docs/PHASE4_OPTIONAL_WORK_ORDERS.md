# Phase 4 可选工单说明（供是否继续制作判断）

必做工单（WO-401、402、404、405）已完成。以下为**可选**工单的 scope、验收标准与实现成本简述，便于你决定是否在本阶段实现。

---

## WO-403：轻量规划（可选）

| 项目 | 说明 |
|------|------|
| **范围** | 对「复杂请求」先让模型输出「步骤列表」不执行，再按步执行并每步更新「已完成/未完成」；可约束最大步数。 |
| **验收** | 可选开启；步骤列表与执行分离；不破坏现有单轮流程。 |
| **实现要点** | 配置项（如 `planning.enabled`）；在首轮或检测到复杂请求时插入一轮「只规划不执行」的 system/user 提示，模型返回步骤列表；后续轮将步骤列表注入上下文，每步执行后更新状态。 |
| **成本** | 中：需定义「复杂请求」启发式（如消息长度、关键词）、步骤解析格式、与现有 loop 的衔接。 |
| **建议** | 若你希望多步任务（如「先读 A 再改 B 再跑 C」）更有条理、可追溯，可做；否则可延后。 |

---

## WO-406：会话快照与恢复（可选）

| 项目 | 说明 |
|------|------|
| **范围** | 定期将会话状态（摘要 + 最近轮 + 可选工具注册）序列化到文件；恢复时从文件加载并继续。 |
| **验收** | 快照可写可读；恢复后对话可继续。 |
| **实现要点** | `src/session/snapshot.ts`：序列化 `{ sessionId, sessionGoal?, sessionSummary?, messages (最近 N 轮) }` 到 `workspace/.rzeclaw/snapshots/<id>.json`；Gateway 在断线或定时时写快照；提供「从快照恢复」的入口（如 method `session.restore` 或启动参数）。 |
| **成本** | 中：需约定快照格式、触发时机（每 N 轮 / 断线前）、恢复时与现有 Session 的合并逻辑。 |
| **建议** | 长会话、易断线或需要「暂停后继续」时很有用；若当前以短会话为主可延后。 |

---

## WO-407：冷归档与审计日志（可选）

| 项目 | 说明 |
|------|------|
| **范围** | L1 超过一定时间未检索的条目可移入冷表或冷文件，仍可查但不在默认热检索路径；审计日志可单独查询与导出。 |
| **验收** | 冷热分离可配置；审计可追溯。 |
| **实现要点** | 冷归档：在 JSONL 或存储层增加「冷」文件/表，定时或按条件将「created_at 早于 T 且近期未被检索」的 L1 条目迁移到冷存储；检索时默认只查热，可选查冷。审计：当前已有 `audit.jsonl` 写入；可增加「按 session_id / entry_id / 时间范围查询与导出」的脚本或 API。 |
| **成本** | 中高：冷热分离需动存储层与检索路径，并定义「近期未检索」的度量（如需额外索引或扫描）。审计查询为轻量（读 audit 文件过滤即可）。 |
| **建议** | 记忆量很大、希望控制热数据体积或需合规审计时再做；当前数据量不大时可延后。 |

---

## 总结

| 工单 | 建议优先级 | 一句话 |
|------|------------|--------|
| **WO-403** | 按需 | 多步任务希望「先列计划再执行」时做。 |
| **WO-406** | 按需 | 长会话 / 断线恢复 / 暂停继续场景做。 |
| **WO-407** | 延后 | 记忆与审计规模上来后再做。 |

实现计划中的**必做内容已全部完成**。若你决定实现上述任一项，可按 WO-403 → WO-406 → WO-407 的顺序做，依赖关系见《实现计划与工单》中的依赖图。

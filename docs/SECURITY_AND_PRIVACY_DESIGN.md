# 安全与隐私设计：原则、现状与目标设计

本文档对照三项原则对当前实现进行检查，识别差距，并给出目标设计与实施方向。实施计划与工单见 **`docs/SECURITY_PRIVACY_IMPLEMENTATION_PLAN.md`**。

---

## 原则一：非破坏性 — 操作系统合理使用范围内，问题即时检查与纠正

### 1.1 原则要点

- 智能助手**不应对操作系统进行破坏性构建与操作**。
- 所有处理内容均在**操作系统合理使用范围内**。
- 若出现问题，**即时进行检查与纠正**。

### 1.2 当前实现检查

| 维度 | 现状 | 说明 |
|------|------|------|
| **文件路径边界** | ✅ 已实现 | `validation.ts` 与 read/write/edit 均通过 `ensureInWorkspace` 限制路径在 workspace 内，禁止 `..` 或绝对路径越界。 |
| **Bash 命令内容** | ❌ 未限制 | `bash.ts` 仅校验 command 非空，**未**对危险命令（如 `rm -rf /`、`format`、`del /f/s/q \`、`> nul` 清盘、`wmic` 破坏性调用等）做检测、拦截或确认。 |
| **进程终止** | ⚠️ 部分风险 | `process` 工具可对任意 pid 发 SIGTERM；未保护系统关键进程（如 PID 1、关键服务），也未与「需确认」策略统一。 |
| **L2/L3 操作范围** | ✅ 已限制 | `allowedApps` 白名单限制可操作应用；`confirmPolicy` 可对指定工具要求确认。 |
| **事后检查与纠正** | ❌ 未实现 | 无「执行后审计」判断是否发生破坏性结果；无自动回滚或告警链路。 |

### 1.3 差距小结（原则一）

1. **Bash 危险命令**：缺少危险模式检测与策略（拦截 / 仅 dry-run / 需用户确认）。
2. **process kill**：缺少对关键进程的保护与可选确认。
3. **事后检查与纠正**：缺少基于 ops.log / 结果的「破坏性行为」判定与告警/纠正入口。

### 1.4 目标设计（原则一）

- **危险命令策略**  
  - 配置层：`security.dangerousCommands`：`block`（直接拒绝）/ `confirm`（需用户确认）/ `dryRunOnly`（仅返回将执行内容）。  
  - 内置危险模式列表（可配置扩展）：如 `rm -rf` 根路径、`format`、`del /f/s/q` 全盘、`:(){ :\|:& };:`、`mkfs`、`dd` 裸写等；匹配到则走上述策略。  
  - 执行前统一经「安全策略层」判断；若为 confirm，则与现有 confirmPolicy 打通（或返回需确认的 ToolResult），由 Gateway/CLI 统一提示用户。

- **process kill 保护**  
  - 配置层：`security.protectedPids`（可选）或「禁止 kill 的进程名/规则」；或 `security.processKillRequireConfirm: true` 与 confirmPolicy 统一。  
  - 执行 kill 前校验 pid 是否在保护集或是否需确认；必要时返回需确认结果。

- **事后检查与纠正**  
  - **执行后审计**：在 appendOpLog 后（或异步）对本次操作做「危险分类」标记（如 `risk_level: low|medium|high`），仅标记不阻断。  
  - **纠正入口**：self-check 增加「最近 N 条操作风险扫描」；若发现 high 风险，输出建议（如「请检查 workspace 与系统状态」）并可链接到 undo_last / replay 文档。  
  - 可选：Gateway/CLI 在会话结束时若存在 high 风险操作，提示用户「建议检查工作区或执行 undo」。

---

## 原则二：最小权限与权限使用体验 — 默认最小权限，可长期/短暂/定时开通，平衡体验与全托管

### 2.1 原则要点

- **默认最小权限**：对文件及相关操作采用最小权限。
- 用户可按需**长期 / 短暂 / 定时**开通权限。
- **体验与全托管**：友好交互，避免过于频繁打断；但权限使用要有**必要性**，不做为避免频繁询问而导致的复杂、低效方式。

### 2.2 当前实现检查

| 维度 | 现状 | 说明 |
|------|------|------|
| **工具级确认** | ✅ 已实现 | `ideOperation.confirmPolicy.tools` 可列出需确认的工具；`requireConfirm` 可全局要求确认。确认时返回 `REQUIRES_CONFIRMATION`，不执行。 |
| **L2/L3 白名单** | ✅ 已实现 | `allowedApps` 限制可操作/键鼠目标应用；未在白名单则直接拒绝。 |
| **权限粒度** | ⚠️ 粗粒度 | 仅有「工具是否需确认」与「应用白名单」，无「读/写/执行」分 scope、无「本次会话/临时/长期」的显式模型。 |
| **默认最小** | ⚠️ 部分 | 写/编辑/ bash/ process 默认均可执行（仅路径在 workspace 内）；「默认只读、写需开通」等未成体系。 |
| **临时/定时开通** | ❌ 未实现 | 无「允许 5 分钟」「本会话允许写」等临时授权；无定时开通策略。 |
| **全托管与频率平衡** | ⚠️ 未设计 | 多次写操作会多次触发确认（若该工具在 confirmPolicy 中）；无「本会话已授权写」的一次性授权，易造成频繁询问。 |

### 2.3 差距小结（原则二）

1. **权限模型不统一**：缺少清晰的「权限域」（如 file_read / file_write / bash / process_kill / ui_automation / keymouse）与默认策略表。
2. **临时/长期/定时**：无临时授权、会话级授权、定时开通的配置与实现。
3. **体验与频率**：需设计「一次性会话授权」「短期授权」以减少重复确认，同时保持「必要时才要权限」的平衡。

### 2.4 目标设计（原则二）

- **权限域（Scope）与默认策略**  
  - 定义权限域：`file_read`、`file_write`、`bash`、`process_kill`、`ui_automation`、`keymouse` 等。  
  - 默认策略表（可配置覆盖）：例如 `file_read` + `bash`（只读+执行）默认允许；`file_write`、`process_kill`、`ui_automation`、`keymouse` 默认「需确认」或「需授权」。  
  - 工具与权限域映射：write/edit → file_write；bash → bash；process kill → process_kill；ui_* → ui_automation；keymouse → keymouse。

- **授权类型**  
  - **长期**：配置项或「信任此工作区」持久化，等同于当前 allowedApps + confirmPolicy 的持久配置。  
  - **短暂/会话**：内存中的「本会话已授权 scope 列表」；用户在一次确认中选择「本次会话允许 file_write」，则本会话内所有 file_write 类工具不再弹确认。  
  - **定时**：可选配置，如「每日 9–18 点允许 file_write」；实现可为在每次工具执行前检查「当前时间是否在允许窗口内」。

- **交互与平衡**  
  - **首次需要高权限时**：提示「需要 [file_write] 权限以执行 write。是否允许：本次会话 / 仅此次 / 长期（写入配置）？」  
  - **避免每次写都问**：若用户选择「本次会话」，则会话内同 scope 不再询问；会话结束（断开/关闭）即失效。  
  - **必要性**：仅在实际调用到该工具且当前策略为「需确认/需授权」时才提示，不做预授权或过度授权。

- **配置形态建议**  
  - `security.permissionScopes`：各 scope 的默认行为 `allow | confirm | deny`。  
  - `security.sessionGrants`：仅运行时内存，不落盘；Gateway 会话绑定。  
  - 可选：`security.scheduledGrants`：如 `{ scope: "file_write", window: "09:00-18:00" }`。

---

## 原则三：用户隐私 — 全面管控与防护，隐私内容沙盒，不泄露

### 3.1 原则要点

- 用户隐私内容要有**良好的管控与管理**。
- **涉及隐私的对话或使用**做**沙盒处理**。
- 在**整个智能助手中**对隐私进行**全面管理与防护**，**确保不泄露**隐私内容。

### 3.2 当前实现检查

| 维度 | 现状 | 说明 |
|------|------|------|
| **写入记忆前的脱敏** | ✅ 已实现 | `write-pipeline.ts` 中 `sanitizeForMemory`：API Key、password/secret、路径等替换为占位符；若含敏感则整段不写入 L1。 |
| **记忆检索与输出** | ⚠️ 未隔离 | 检索到的记忆会进入 prompt；若某条曾脱敏，则输出为占位符，但**未**对「隐私会话」做隔离存储或标记。 |
| **会话/快照** | ❌ 未脱敏 | 会话快照、Gateway 内存中的会话消息若含用户隐私，会原样持久化或驻留内存；无「隐私会话」标记与单独策略。 |
| **ops.log / 审计** | ⚠️ 未脱敏 | `OpLogEntry` 含 `args`、`result_summary`；若工具参数或结果含敏感信息会原样写入 ops.log；导出 audit 时未做敏感字段过滤。 |
| **隐私沙盒** | ❌ 未实现 | 无「隐私模式」或「隐私会话」：不限制工具调用时，隐私对话可能触发 write/bash 等，导致敏感进入文件或命令；无「仅对话、不落盘」的沙盒。 |
| **端到端标记** | ❌ 未实现 | 无从「用户标记隐私」或「模型/规则检测隐私意图」到存储/导出的一致标记与过滤。 |

### 3.3 差距小结（原则三）

1. **隐私边界不清晰**：无显式「隐私会话/隐私模式」与沙盒策略。
2. **存储与导出**：ops.log、audit 导出、快照、会话持久化可能携带敏感内容，未统一脱敏或排除。
3. **沙盒行为**：隐私模式下应限制「可落盘、可外泄」的操作（如禁止写文件、禁止将内容带入非隐私记忆），或使用独立隔离存储。

### 3.4 目标设计（原则三）

- **隐私会话 / 隐私模式**  
  - **入口**：用户通过「隐私模式」开关发起会话（Gateway 参数或 CLI 参数）；或由模型/规则根据用户表述（如「以下内容保密」）自动进入隐私模式并回复确认。  
  - **策略**：  
    - 隐私会话内：**不写入 L1 记忆**（或写入到「隐私隔离存储」，仅本会话可见、会话结束可销毁）。  
    - 可选：隐私会话内**禁止** write/edit/bash 等可落盘/执行命令，或仅允许 read（只读），避免敏感经工具泄露。  
  - **生命周期**：会话结束即销毁隐私隔离存储（或用户可选「保留 N 天」）；不参与全局检索与导出。

- **全面脱敏与不泄露**  
  - **写入前**：保持并扩展 `sanitizeForMemory`；对 ops.log 的 `args`/`result_summary` 在写入前做同规则脱敏（或对敏感 key 做 value 占位）。  
  - **导出与检索**：audit-export、metrics-export、replay_ops 等导出或对外输出时，对已知敏感字段（如含 password、token、路径等）做脱敏或过滤。  
  - **快照**：若会话标记为隐私，快照不持久化或持久化到加密/临时区并在会话结束时清理。

- **端到端标记**  
  - 会话级：`sessionFlags.privacy: true` 贯穿 Gateway/Agent；所有存储与导出逻辑检查该标记并应用隐私策略。  
  - 可选：对单条消息或工具结果打 `contains_sensitive`，用于决定是否写入 L1、是否写入 ops 详细内容。

---

## 与现有配置的衔接

- **原则一**：新增或复用 `security.dangerousCommands`、`security.protectedPids`、`security.processKillRequireConfirm`；与现有 `confirmPolicy` 协同。  
- **原则二**：新增 `security.permissionScopes`、`security.sessionGrants`（仅内存）、可选 `security.scheduledGrants`；与现有 `ideOperation.confirmPolicy`、`allowedApps` 合并或兼容（如 confirmPolicy 映射为 file_write 的 confirm）。  
- **原则三**：新增 `sessionFlags.privacy`、隐私模式下的工具与记忆策略；与现有 `sanitizeForMemory`、记忆开关兼容。

---

## 总结对照表

| 原则 | 已实现 | 主要差距 | 设计方向 |
|------|--------|----------|----------|
| **一：非破坏性** | 路径边界、L2/L3 白名单与确认 | Bash 无危险命令策略；process kill 无保护；无事后检查与纠正 | 危险命令策略、kill 保护、执行后风险标记与 self-check 纠正入口 |
| **二：最小权限与体验** | 工具确认、allowedApps | 无统一权限域与临时/定时授权；易频繁询问 | 权限域与默认策略、会话/临时/定时授权、一次会话授权减少打断 |
| **三：隐私** | L1 写入前脱敏 | 会话/快照/ops/导出未全面脱敏；无隐私沙盒与端到端标记 | 隐私会话与沙盒、ops/导出/快照脱敏、sessionFlags.privacy 贯穿 |

实施时优先实现「原则一」的危险命令与 kill 保护、「原则三」的 ops/导出脱敏与隐私会话沙盒，再推进「原则二」的权限域与会话授权，以平衡安全与体验。
